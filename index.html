<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wasteland Survival 2D</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #121212;
            color: #33ff33;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        #game-wrapper {
            max-width: 500px;
            width: 100%;
        }
        canvas {
            background-color: #222;
            border: 2px solid #33ff33;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.2);
            display: block;
            margin-bottom: 15px;
        }
        .status-bar {
            background: #000;
            border: 2px solid #33ff33;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        #game-log {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #333;
            background: #0a0a0a;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            line-height: 1.4;
            border-radius: 4px;
        }
        .log-entry { margin-bottom: 8px; }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        button {
            background-color: #33ff33;
            color: #000;
            border: none;
            padding: 12px;
            font-size: 1em;
            font-weight: bold;
            font-family: inherit;
            cursor: pointer;
            border-radius: 4px;
            flex: 1;
            min-width: 100px;
        }
        button:hover { background-color: #29cc29; }
        .sys-btn { background-color: #555; color: #fff; padding: 8px; font-size: 0.85em; }
        .sys-btn:hover { background-color: #777; }
        
        #inventory-panel {
            display: none;
            border: 1px solid #33ff33;
            padding: 10px;
            background: #111;
        }
        .inv-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding: 8px 0;
            font-size: 0.85em;
        }
        .inv-btn { padding: 5px 10px; font-size: 0.8em; flex: none; margin-left: 10px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="500" height="300"></canvas>

    <div class="status-bar">
        <div class="status-row">
            <span id="stat-level">Lvl: 1</span>
            <span id="stat-hp">HP: 100/100</span>
            <span id="stat-xp">XP: 0/50</span>
        </div>
        <div class="status-row">
            <span id="stat-weapon">Wep: Fists</span>
            <span id="stat-armor">Arm: Clothes</span>
        </div>
    </div>

    <div id="game-log"></div>

    <div class="controls" id="main-controls">
        <button id="btn-inventory" onclick="toggleInventory()">Open Inventory</button>
    </div>
    
    <div class="controls" id="combat-controls" style="display: none;">
        <button id="btn-attack" onclick="attack()">Attack</button>
        <button id="btn-flee" onclick="flee()">Flee</button>
    </div>

    <div class="controls" id="sys-controls" style="margin-top: 15px; border-top: 1px dashed #333; padding-top: 15px;">
        <button class="sys-btn" onclick="saveGame()">Save Game</button>
        <button class="sys-btn" onclick="loadGame()">Load Game</button>
    </div>

    <div id="inventory-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
            <strong>Your Items</strong>
            <button class="inv-btn" onclick="toggleInventory()" style="background:#ff3333; color:white;">Close</button>
        </div>
        <div id="inventory-list"></div>
    </div>
</div>

<script>
    // ==========================================
    // CLASSES & DATA
    // ==========================================
    class Item {
        constructor(name, desc, type, power) {
            this.name = name; this.desc = desc; this.type = type; this.power = power;
        }
    }

    class Player {
        constructor() {
            this.hp = 100; this.maxHp = 100; this.baseAttack = 15;
            this.level = 1; this.xp = 0; this.xpToLevel = 50;
            this.inventory = []; this.weapon = null; this.armor = null;
            // 2D Canvas Properties
            this.x = 240; this.y = 140; 
            this.width = 20; this.height = 20; 
            this.speed = 3;
        }
        isAlive() { return this.hp > 0; }
        get totalAttack() { return this.baseAttack + (this.weapon ? this.weapon.power : 0); }
        get totalDefense() { return this.armor ? this.armor.power : 0; }

        takeDamage(damage) {
            let actual = damage - this.totalDefense;
            if (actual < 1) actual = 1;
            this.hp -= actual;
            if (this.hp < 0) this.hp = 0;
            return actual;
        }
        heal(amount) {
            this.hp = Math.min(this.maxHp, this.hp + amount);
            log(`You healed! Current HP: ${this.hp}/${this.maxHp}`, "#33ff33");
        }
        gainXp(amount) {
            this.xp += amount;
            log(`You gained ${amount} XP!`);
            if (this.xp >= this.xpToLevel) {
                this.level++; this.xp -= this.xpToLevel; this.xpToLevel = Math.floor(this.xpToLevel * 1.5);
                this.maxHp += 20; this.hp = this.maxHp; this.baseAttack += 5;
                log(`*** LEVEL UP! You are now Level ${this.level} ***`, "#ffff33");
            }
        }
    }

    class MapEntity {
        constructor(x, y, data, type) {
            this.x = x; this.y = y;
            this.width = 15; this.height = 15;
            this.data = data; // Holds Enemy or Item info
            this.type = type; // 'enemy' or 'item'
        }
    }

    const possibleItems = [
        new Item("Dirty Bandage", "Heals 15 HP.", "heal", 15),
        new Item("First Aid Kit", "Heals 60 HP.", "heal", 60),
        new Item("Rusty Pipe", "Weapon.", "weapon", 5),
        new Item("Machete", "Weapon.", "weapon", 12),
        new Item("Scrap Armor", "Armor.", "armor", 8)
    ];

    const possibleEnemies = [
        { name: "Mutant Hound", hp: 30, atk: 8, xp: 20 },
        { name: "Wasteland Scavenger", hp: 50, atk: 12, xp: 35 }
    ];

    const player = new Player();
    let entities = []; // Holds items and enemies currently on the map
    let currentEnemy = null;
    let gameState = 'EXPLORE'; 

    // ==========================================
    // 2D ENGINE (CANVAS)
    // ==========================================
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const keys = {};

    window.addEventListener("keydown", (e) => keys[e.key] = true);
    window.addEventListener("keyup", (e) => keys[e.key] = false);

    function spawnEntities() {
        // Keep the map populated with at least 3 enemies and 3 items
        let enemyCount = entities.filter(e => e.type === 'enemy').length;
        let itemCount = entities.filter(e => e.type === 'item').length;

        while(enemyCount < 3) {
            let t = possibleEnemies[Math.floor(Math.random() * possibleEnemies.length)];
            let eData = { name: t.name, hp: t.hp + (player.level*5), maxHp: t.hp + (player.level*5), baseAttack: t.atk + (player.level*2), xpReward: t.xp + (player.level*10) };
            entities.push(new MapEntity(Math.random() * 460 + 20, Math.random() * 260 + 20, eData, 'enemy'));
            enemyCount++;
        }
        while(itemCount < 3) {
            let iData = possibleItems[Math.floor(Math.random() * possibleItems.length)];
            entities.push(new MapEntity(Math.random() * 460 + 20, Math.random() * 260 + 20, iData, 'item'));
            itemCount++;
        }
    }

    function checkCollision(r1, r2) {
        return !(r2.x > r1.x + r1.width || r2.x + r2.width < r1.x || r2.y > r1.y + r1.height || r2.y + r2.height < r1.y);
    }

    function updateGameLoop() {
        if (gameState === 'EXPLORE' && player.isAlive()) {
            // Player Movement
            if ((keys["ArrowUp"] || keys["w"]) && player.y > 0) player.y -= player.speed;
            if ((keys["ArrowDown"] || keys["s"]) && player.y + player.height < canvas.height) player.y += player.speed;
            if ((keys["ArrowLeft"] || keys["a"]) && player.x > 0) player.x -= player.speed;
            if ((keys["ArrowRight"] || keys["d"]) && player.x + player.width < canvas.width) player.x += player.speed;

            // Check Collisions
            for (let i = 0; i < entities.length; i++) {
                if (checkCollision(player, entities[i])) {
                    let hit = entities.splice(i, 1)[0]; // Remove from map
                    
                    if (hit.type === 'item') {
                        player.inventory.push(hit.data);
                        log(`You picked up a ${hit.data.name}!`, "#33ccff");
                    } else if (hit.type === 'enemy') {
                        currentEnemy = hit.data;
                        gameState = 'COMBAT';
                        keys["ArrowUp"] = keys["ArrowDown"] = keys["ArrowLeft"] = keys["ArrowRight"] = false; // Stop movement
                        log(`Combat Started! A ${currentEnemy.name} attacks!`, "#ff3333");
                    }
                    updateUI();
                    break; 
                }
            }
        }
        
        // Drawing
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw Entities
        entities.forEach(e => {
            ctx.fillStyle = e.type === 'enemy' ? '#ff3333' : '#ffff33'; // Red for enemy, Gold for item
            ctx.fillRect(e.x, e.y, e.width, e.height);
        });

        // Draw Player (Blue)
        if (player.isAlive()) {
            ctx.fillStyle = '#33ccff';
            ctx.fillRect(player.x, player.y, player.width, player.height);
        }

        requestAnimationFrame(updateGameLoop);
    }

    // ==========================================
    // UI & COMBAT LOGIC
    // ==========================================
    function log(msg, color = "#33ff33") {
        const d = document.getElementById("game-log");
        d.innerHTML += `<div style="color:${color}; margin-bottom:4px;">${msg}</div>`;
        d.scrollTop = d.scrollHeight; 
    }

    function updateUI() {
        document.getElementById("stat-level").innerText = `Lvl: ${player.level}`;
        document.getElementById("stat-hp").innerText = `HP: ${player.hp}/${player.maxHp}`;
        document.getElementById("stat-xp").innerText = `XP: ${player.xp}/${player.xpToLevel}`;
        document.getElementById("stat-weapon").innerText = `Wep: ${player.weapon ? player.weapon.name : "Fists"}`;
        document.getElementById("stat-armor").innerText = `Arm: ${player.armor ? player.armor.name : "Clothes"}`;

        document.getElementById("combat-controls").style.display = gameState === 'COMBAT' ? "flex" : "none";
        document.getElementById("sys-controls").style.display = gameState === 'COMBAT' ? "none" : "flex";
        
        if (!player.isAlive()) {
            document.getElementById("main-controls").innerHTML = `<button onclick="location.reload()">Restart Game</button>`;
        }
    }

    function attack() {
        let dmg = Math.floor(Math.random() * 7) - 3 + player.totalAttack; 
        currentEnemy.hp -= dmg;
        log(`You hit the ${currentEnemy.name} for ${dmg} damage!`);

        if (currentEnemy.hp <= 0) {
            log(`You defeated the ${currentEnemy.name}!`, "#33ccff");
            player.gainXp(currentEnemy.xpReward);
            gameState = 'EXPLORE';
            currentEnemy = null;
            spawnEntities(); // Respawn map entities
            updateUI();
            return;
        }

        let eDmg = Math.floor(Math.random() * 5) - 2 + currentEnemy.baseAttack;
        let taken = player.takeDamage(eDmg);
        log(`The ${currentEnemy.name} hits you for ${taken} damage!`, "#ff3333");

        if (!player.isAlive()) log("*** YOU DIED! ***", "#ff0000");
        updateUI();
    }

    function flee() {
        if (Math.random() > 0.5) {
            log("You ran away!");
            gameState = 'EXPLORE';
            // Push player slightly away from the enemy's last spot so they don't instantly recollide
            player.x -= 20; 
            currentEnemy = null;
        } else {
            log("You couldn't escape!", "#ff3333");
            let taken = player.takeDamage(currentEnemy.baseAttack);
            log(`The ${currentEnemy.name} strikes your back for ${taken} damage!`, "#ff3333");
            if (!player.isAlive()) log("*** YOU DIED! ***", "#ff0000");
        }
        updateUI();
    }

    // ==========================================
    // INVENTORY & SAVE SYSTEM
    // ==========================================
    function toggleInventory() {
        let p = document.getElementById("inventory-panel");
        if(p.style.display === "block") p.style.display = "none";
        else { renderInventory(); p.style.display = "block"; }
    }

    function renderInventory() {
        let list = document.getElementById("inventory-list");
        if(player.inventory.length === 0) { list.innerHTML = "Empty."; return; }
        
        list.innerHTML = player.inventory.map((item, i) => {
            let action = item.type === 'heal' ? 'Use' : 'Equip';
            let stats = item.type === 'weapon' ? `[+${item.power} ATK]` : item.type === 'armor' ? `[+${item.power} DEF]` : `[+${item.power} HP]`;
            return `<div class="inv-item"><span>${item.name} ${stats}</span> <button class="inv-btn" onclick="useItem(${i})">${action}</button></div>`;
        }).join('');
    }

    function useItem(i) {
        let item = player.inventory.splice(i, 1)[0]; 
        if (item.type === 'heal') player.heal(item.power);
        else if (item.type === 'weapon') { if(player.weapon) player.inventory.push(player.weapon); player.weapon = item; }
        else if (item.type === 'armor') { if(player.armor) player.inventory.push(player.armor); player.armor = item; }
        updateUI(); renderInventory();
    }

    function saveGame() {
        localStorage.setItem("waste2D_save", JSON.stringify({ player, entities }));
        log("Game saved successfully!", "#ffff33");
    }

    function loadGame() {
        let s = localStorage.getItem("waste2D_save");
        if (s) {
            let data = JSON.parse(s);
            Object.assign(player, data.player);
            entities = data.entities;
            log("Game loaded successfully!", "#ffff33");
            updateUI();
        } else log("No save file found.", "#ff3333");
    }

    // Initialize Game
    log("Use W, A, S, D or Arrow Keys to move.");
    log("Touch GOLD to loot, touch RED to fight.");
    spawnEntities();
    updateUI();
    requestAnimationFrame(updateGameLoop);
</script>

</body>
</html>
